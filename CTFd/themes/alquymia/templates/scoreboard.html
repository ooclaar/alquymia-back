{% extends "base.html" %}

{% block stylesheets %}
{{ super() }}
<style>
    .leaderboard-page {
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
    }
    .chart-section {
        padding: 40px 0;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="challenges-hero">
    <div class="event-badge" style="display: inline-block; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; font-weight: 600; padding: 0.6rem 1.5rem; border: 2px solid #FF8C00; border-radius: 50px; color: #FF8C00; letter-spacing: 2px; margin-bottom: 2rem; text-transform: uppercase; box-shadow: 0 0 20px rgba(255, 140, 0, 0.3);">4¬™ EDI√á√ÉO</div>
    <h1 class="glitch" data-text="CLASSIFICA√á√ÉO">CLASSIFICA√á√ÉO</h1>
    <p class="subtitle">Acompanhe o ranking em tempo real e veja quem est√° dominando o CTF</p>
</section>

<!-- Stats Section -->
<section class="hero-stats-section">
    <div class="container">
        <div class="hero-stats">
            <div class="stat-item">
                <div class="stat-number" id="total-teams">-</div>
                <div class="stat-label">EQUIPES</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="total-solves">-</div>
                <div class="stat-label">FLAGS CAPTURADAS</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="time-remaining">-</div>
                <div class="stat-label">TEMPO RESTANTE</div>
            </div>
        </div>
    </div>
</section>

<!-- Progress Chart Section (Isolado para estabilidade) -->
<section class="chart-section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div id="score-graph-container" class="chart-container">
                    <canvas id="score-chart"></canvas>
                    <div id="chart-loading" class="text-center py-5">
                        <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Leaderboard Section -->
<section class="leaderboard-section">
    <div class="container">
        {% include "components/errors.html" %}
        
        <div id="scoreboard" class="row" x-data="ScoreboardList">
            <template x-if="brackets.length && standings.length">
                <div class="col-md-12 py-3">
                    <nav class="nav nav-pills nav-fill">
                        <button :class="{'nav-link': true, 'active': !activeBracket}" @click="activeBracket=null">Todos</button>
                        <template x-for="bracket in brackets">
                            <button :class="{'nav-link': true, 'active': activeBracket == bracket.id}" x-text="bracket.name" @click="activeBracket=bracket.id"></button>
                        </template>
                    </nav>
                </div>
            </template>

            <div class="col-md-12" x-show="standings.length">
                <h2 class="section-title">üèÜ Top {{ get_mode_as_word(capitalize=True, plural=True) }}</h2>
                
                <div class="leaderboard-table">
                    <div class="table-header">
                        <div class="col-rank">Posi√ß√£o</div>
                        <div class="col-team">{{ get_mode_as_word(capitalize=True) }}</div>
                        <div class="col-points">Pontos</div>
                    </div>

                    <template x-for="(standing, index) in standings.filter(i => activeBracket ? i.bracket_id==activeBracket : true)">
                        <div class="table-row" :class="{'rank-1': index === 0, 'rank-2': index === 1, 'rank-3': index === 2}">
                            <div class="col-rank">
                                <span class="rank-badge" 
                                      :class="{'gold': index === 0, 'silver': index === 1, 'bronze': index === 2}"
                                      x-text="index === 0 ? 'ü•á 1¬∫' : index === 1 ? 'ü•à 2¬∫' : index === 2 ? 'ü•â 3¬∫' : (index + 1) + '¬∫'">
                                </span>
                            </div>
                            <div class="col-team">
                                <div class="team-info">
                                    <div class="team-avatar" x-text="standing.name.substring(0, 2).toUpperCase()"></div>
                                    <div class="team-details">
                                        <a :href="standing.account_url" class="team-name" x-text="standing.name"></a>
                                        <template x-if="standing.bracket_name">
                                            <span class="badge bg-secondary ms-2" x-text="standing.bracket_name"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div class="col-points">
                                <span class="points-value" x-text="standing.score"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="col-md-12 text-center py-5" x-show="! standings.length">
                <h3 class="text-muted">O placar est√° vazio</h3>
                <p class="text-muted">Seja o primeiro a resolver um desafio!</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ Assets.js('assets/js/scoreboard.js') }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('leaderboard-page');

        // Fun√ß√£o para buscar dados e desenhar o gr√°fico
        async function drawScoreboardChart() {
            const chartLoading = document.getElementById('chart-loading');
            const scoreChartContainer = document.getElementById('score-graph-container');

            try {
                // 1. Busca o scoreboard (top 10 equipes)
                const scoreboardResponse = await fetch('/api/v1/scoreboard');
                const scoreboardData = await scoreboardResponse.json();

                if (!scoreboardData.success || scoreboardData.data.length === 0) {
                    // Se n√£o houver equipes, n√£o desenha o gr√°fico
                    scoreChartContainer.style.display = 'none';
                    return;
                }

                // Pega apenas as top 10 equipes
                const top10Teams = scoreboardData.data.slice(0, 10);

                // 2. Para cada equipe, busca seus solves e calcula a pontua√ß√£o ao longo do tempo
                const datasets = [];
                const colors = [
                    '#FF8C00', // Laranja (1¬∫ lugar)
                    '#FFD700', // Dourado (2¬∫ lugar)
                    '#C0C0C0', // Prata (3¬∫ lugar)
                    '#CD7F32', // Bronze (4¬∫ lugar)
                    '#00CED1', // Turquesa
                    '#FF69B4', // Rosa
                    '#32CD32', // Verde lim√£o
                    '#9370DB', // Roxo m√©dio
                    '#FF6347', // Tomate
                    '#4169E1'  // Azul royal
                ];

                // Coletar todos os timestamps √∫nicos para criar labels consistentes
                const allTimestamps = new Set();
                allTimestamps.add(0); // Ponto inicial

                // Busca solves de cada equipe
                const teamsData = await Promise.all(
                    top10Teams.map(async (team, index) => {
                        try {
                            const solvesResponse = await fetch(`/api/v1/teams/${team.account_id}/solves`);
                            const solvesData = await solvesResponse.json();

                            if (!solvesData.success || solvesData.data.length === 0) {
                                return null;
                            }

                            const solves = solvesData.data.sort((a, b) => new Date(a.date) - new Date(b.date));
                            
                            // Adiciona timestamps ao conjunto
                            solves.forEach(solve => {
                                allTimestamps.add(new Date(solve.date).getTime());
                            });

                            return {
                                name: team.name,
                                solves: solves,
                                color: colors[index]
                            };
                        } catch (error) {
                            console.error(`Erro ao buscar solves da equipe ${team.name}:`, error);
                            return null;
                        }
                    })
                );

                // Filtra equipes que n√£o retornaram dados
                const validTeams = teamsData.filter(team => team !== null);

                if (validTeams.length === 0) {
                    scoreChartContainer.style.display = 'none';
                    return;
                }

                // Converte timestamps para array ordenado
                const sortedTimestamps = Array.from(allTimestamps).sort((a, b) => a - b);
                
                // Cria labels a partir dos timestamps
                const labels = sortedTimestamps.map((timestamp, index) => {
                    if (index === 0) return "In√≠cio";
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString();
                });

                // 3. Para cada equipe, cria um dataset
                validTeams.forEach(team => {
                    const dataPoints = [];
                    let accumulatedScore = 0;

                    sortedTimestamps.forEach(timestamp => {
                        if (timestamp === 0) {
                            // Ponto inicial
                            dataPoints.push(0);
                        } else {
                            // Verifica se h√° algum solve neste timestamp
                            const solvesAtThisTime = team.solves.filter(solve => {
                                const solveTime = new Date(solve.date).getTime();
                                return solveTime <= timestamp;
                            });

                            // Calcula pontua√ß√£o acumulada at√© este timestamp
                            accumulatedScore = solvesAtThisTime.reduce((sum, solve) => sum + solve.challenge.value, 0);
                            dataPoints.push(accumulatedScore);
                        }
                    });

                    datasets.push({
                        label: team.name,
                        data: dataPoints,
                        borderColor: team.color,
                        backgroundColor: team.color + '33', // Adiciona transpar√™ncia
                        tension: 0.4,
                        fill: false,
                        borderWidth: 2
                    });
                });

                // 4. Renderiza o gr√°fico
                const ctx = document.getElementById('score-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Pontos',
                                    color: '#FF8C00',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#FFFFFF'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tempo',
                                    color: '#FF8C00',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#FFFFFF',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#FFFFFF',
                                    font: {
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#FF8C00',
                                bodyColor: '#FFFFFF',
                                borderColor: '#FF8C00',
                                borderWidth: 1
                            }
                        }
                    }
                });
                
                // 4. Esconde o spinner
                chartLoading.style.display = 'none';

            } catch (error) {
                console.error("Erro ao desenhar o gr√°fico de pontua√ß√£o:", error);
                scoreChartContainer.style.display = 'none';
            }
        }

        // Desenha o gr√°fico na inicializa√ß√£o
        drawScoreboardChart();

        // Fun√ß√£o para atualizar as estat√≠sticas
        async function updateStats() {
            try {
                // Busca total de equipes
                const teamsResponse = await fetch('/api/v1/teams');
                const teamsData = await teamsResponse.json();
                const totalTeams = teamsData.success ? teamsData.data.length : 0;
                document.getElementById('total-teams').textContent = totalTeams;

                // Busca total de solves (flags capturadas)
                const scoreboardResponse = await fetch('/api/v1/scoreboard');
                const scoreboardData = await scoreboardResponse.json();
                let totalSolves = 0;
                if (scoreboardData.success) {
                    // Soma todos os solves de todas as equipes
                    for (const team of scoreboardData.data) {
                        const solvesResponse = await fetch(`/api/v1/teams/${team.account_id}/solves`);
                        const solvesData = await solvesResponse.json();
                        if (solvesData.success) {
                            totalSolves += solvesData.data.length;
                        }
                    }
                }
                document.getElementById('total-solves').textContent = totalSolves;

                // Calcula tempo restante
                const ctfEnd = new Date(window.init.end * 1000);
                const now = new Date();
                const timeRemaining = Math.max(0, Math.floor((ctfEnd - now) / (1000 * 60 * 60 * 24))); // Dias restantes
                document.getElementById('time-remaining').textContent = timeRemaining;

            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
                document.getElementById('total-teams').textContent = '-';
                document.getElementById('total-solves').textContent = '-';
                document.getElementById('time-remaining').textContent = '-';
            }
        }

        // Atualiza as estat√≠sticas na inicializa√ß√£o
        updateStats();

        // Atualiza as estat√≠sticas a cada 30 segundos
        setInterval(updateStats, 30000);
    });
</script>
{% endblock %}
