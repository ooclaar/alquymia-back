{% extends "base.html" %}

{% block stylesheets %}
{{ super() }}
<style>
    .leaderboard-page {
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
    }
    .chart-section {
        padding: 40px 0;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="challenges-hero">
    <div class="event-badge" style="display: inline-block; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; font-weight: 600; padding: 0.6rem 1.5rem; border: 2px solid #FF8C00; border-radius: 50px; color: #FF8C00; letter-spacing: 2px; margin-bottom: 2rem; text-transform: uppercase; box-shadow: 0 0 20px rgba(255, 140, 0, 0.3);">4춹 EDI칂츾O</div>
    <h1 class="glitch" data-text="CLASSIFICA칂츾O">CLASSIFICA칂츾O</h1>
    <p class="subtitle">Acompanhe o ranking em tempo real e veja quem est치 dominando o CTF</p>
</section>

<!-- Progress Chart Section (Isolado para estabilidade) -->
<section class="chart-section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h2 class="section-title">游늴 Progresso de Pontua칞칚o</h2>
                <div id="score-graph-container" class="chart-container">
                    <canvas id="score-chart"></canvas>
                    <div id="chart-loading" class="text-center py-5">
                        <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Leaderboard Section -->
<section class="leaderboard-section">
    <div class="container">
        {% include "components/errors.html" %}
        
        <div id="scoreboard" class="row" x-data="ScoreboardList">
            <template x-if="brackets.length && standings.length">
                <div class="col-md-12 py-3">
                    <nav class="nav nav-pills nav-fill">
                        <button :class="{'nav-link': true, 'active': !activeBracket}" @click="activeBracket=null">Todos</button>
                        <template x-for="bracket in brackets">
                            <button :class="{'nav-link': true, 'active': activeBracket == bracket.id}" x-text="bracket.name" @click="activeBracket=bracket.id"></button>
                        </template>
                    </nav>
                </div>
            </template>

            <div class="col-md-12" x-show="standings.length">
                <h2 class="section-title">游끥 Top {{ get_mode_as_word(capitalize=True, plural=True) }}</h2>
                
                <div class="leaderboard-table">
                    <div class="table-header">
                        <div class="col-rank">Posi칞칚o</div>
                        <div class="col-team">{{ get_mode_as_word(capitalize=True) }}</div>
                        <div class="col-points">Pontos</div>
                    </div>

                    <template x-for="(standing, index) in standings.filter(i => activeBracket ? i.bracket_id==activeBracket : true)">
                        <div class="table-row" :class="{'rank-1': index === 0, 'rank-2': index === 1, 'rank-3': index === 2}">
                            <div class="col-rank">
                                <span class="rank-badge" 
                                      :class="{'gold': index === 0, 'silver': index === 1, 'bronze': index === 2}"
                                      x-text="index === 0 ? '游볞 1췈' : index === 1 ? '游볟 2췈' : index === 2 ? '游볠 3췈' : (index + 1) + '췈'">
                                </span>
                            </div>
                            <div class="col-team">
                                <div class="team-info">
                                    <div class="team-avatar" x-text="standing.name.substring(0, 2).toUpperCase()"></div>
                                    <div class="team-details">
                                        <a :href="standing.account_url" class="team-name" x-text="standing.name"></a>
                                        <template x-if="standing.bracket_name">
                                            <span class="badge bg-secondary ms-2" x-text="standing.bracket_name"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div class="col-points">
                                <span class="points-value" x-text="standing.score"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="col-md-12 text-center py-5" x-show="! standings.length">
                <h3 class="text-muted">O placar est치 vazio</h3>
                <p class="text-muted">Seja o primeiro a resolver um desafio!</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ Assets.js('assets/js/scoreboard.js') }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('leaderboard-page');

        // Fun칞칚o para buscar dados e desenhar o gr치fico
        async function drawScoreboardChart() {
            const chartLoading = document.getElementById('chart-loading');
            const scoreChartContainer = document.getElementById('score-graph-container');

            try {
                // 1. Busca dados do usu치rio logado para pegar o team_id
                const userResponse = await fetch('/api/v1/users/me');
                const userData = await userResponse.json();
                
                if (!userData.success || !userData.data.team_id) {
                    // Se n칚o houver equipe, n칚o desenha o gr치fico
                    scoreChartContainer.style.display = 'none';
                    return;
                }

                const teamId = userData.data.team_id;

                // 2. Busca os solves da equipe
                const solvesResponse = await fetch(`/api/v1/teams/${teamId}/solves`);
                const solvesData = await solvesResponse.json();

                if (!solvesData.success || solvesData.data.length === 0) {
                    // Se n칚o houver solves, n칚o desenha o gr치fico
                    scoreChartContainer.style.display = 'none';
                    return;
                }

                // 3. Prepara os dados para o Chart.js
                // O CTFd retorna um array de objetos {date: timestamp, challenge: {...}, value: points}
                // Vamos calcular a pontua칞칚o acumulada ao longo do tempo
                const solves = solvesData.data.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const labels = [];
                const scores = [];
                let accumulatedScore = 0;

                // Adiciona o ponto inicial (0)
                labels.push("In칤cio");
                scores.push(0);

                // Adiciona cada solve
                solves.forEach(solve => {
                    accumulatedScore += solve.challenge.value;
                    const date = new Date(solve.date);
                    labels.push(date.toLocaleTimeString());
                    scores.push(accumulatedScore);
                });

                // 4. Renderiza o gr치fico
                const ctx = document.getElementById('score-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pontua칞칚o',
                            data: scores,
                            borderColor: '#FF8C00',
                            backgroundColor: 'rgba(255, 140, 0, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Pontos'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // 4. Esconde o spinner
                chartLoading.style.display = 'none';

            } catch (error) {
                console.error("Erro ao desenhar o gr치fico de pontua칞칚o:", error);
                scoreChartContainer.style.display = 'none';
            }
        }

        // Desenha o gr치fico na inicializa칞칚o
        drawScoreboardChart();
    });
</script>
{% endblock %}
